<ts-page-scaffold pageAvailability="ready">
  <article class="data-page" style="display: flex; flex-direction: row;">
    <!-- Left sidebar: Schema tool window -->
    <ts-schema-tool-window
      resizable
      [percent]="20"
      [mode]="'data'"
      [title]="'Data Explorer'"
    />

    <!-- Main area: Tabs and content -->
    <div class="main-content" resizable [percent]="80">
      @if ((driver.status$ | async) === "disconnected") {
        <div class="placeholder-container">
          <button mat-flat-button routerLink="/connect">
            <i class="fa-light fa-bolt"></i><span>Connect TypeDB server</span>
          </button>
        </div>
      } @else if (!(driver.database$ | async)) {
        <div class="placeholder-container">
          <button mat-flat-button (click)="openSelectDatabaseDialog()">
            <i class="fa-light fa-database"></i><span>Select database</span>
          </button>
        </div>
      } @else if (showRestoringSpinner$ | async) {
        <div class="loading-state">
          <tp-spinner/>
        </div>
      } @else if (state.restoringTabs$ | async) {
        <!-- Brief restoring period, show nothing -->
      } @else if ((state.openTabs$ | async)!.length > 0) {
        <mat-tab-group
          [selectedIndex]="state.selectedTabIndex$.value"
          (selectedIndexChange)="onTabChange($event)"
          animationDuration="0ms"
          [preserveContent]="true"
          class="type-tabs">
          @for (tab of (state.openTabs$ | async); track getTabTrackId(tab); let i = $index) {
            <mat-tab>
              <ng-template mat-tab-label>
                <div class="tab-label-container"
                     (contextmenu)="openTabContextMenu($event, tab, i)"
                     (auxclick)="onTabAuxClick($event, i)">
                  <span class="tab-label" [class.pinned]="tab.pinned">
                    @if (tab.pinned) {
                      <i class="fa-light fa-thumbtack pin-icon"></i>
                    }
                    @if (tab.kind === 'type-table') {
                      <i class="tab-type-icon" [ngClass]="getTypeIconClass(tab.type.kind, false)"></i>
                      {{ tab.type.label }}
                      @if (tab.totalCount > 0) {
                        <span class="tab-count">({{ tab.totalCount }})</span>
                      }
                    } @else {
                      <i class="tab-type-icon" [ngClass]="getTypeIconClass(tab.type.kind, true)"></i>
                      {{ tab.type.label }}: {{ tab.instanceIID.substring(0, 8) }}...
                    }
                  </span>
                  <button
                    mat-icon-button
                    class="tab-close-button"
                    (click)="closeTab($event, i)">
                    <i class="fa-light fa-xmark"></i>
                  </button>
                </div>
              </ng-template>

              <ng-template matTabContent>
                @if (tab.kind === 'type-table') {
                  <ts-instance-table [tab]="tab" />
                } @else {
                  <ts-instance-detail [type]="tab.type" [instanceIID]="tab.instanceIID" [breadcrumbs]="tab.breadcrumbs" />
                }
              </ng-template>
            </mat-tab>
          }
        </mat-tab-group>
      } @else {
        <div class="empty-state">
          <i class="fa-light fa-table"></i>
          <p>Select a type from the left to view instances</p>
        </div>
      }
    </div>
  </article>
</ts-page-scaffold>

<!-- Tab context menu -->
<div class="tab-context-menu-trigger"
     [style.left.px]="contextMenuPosition.x"
     [style.top.px]="contextMenuPosition.y"
     [matMenuTriggerFor]="tabContextMenu">
</div>

<mat-menu #tabContextMenu="matMenu" [overlapTrigger]="false">
  <ng-template matMenuContent let-tab="tab" let-index="index">
    <span class="menu-content">
      <button mat-menu-item (click)="closeTab($event, index)">Close</button>
      <button mat-menu-item (click)="closeOtherTabs(tab)">Close Others</button>
      <button mat-menu-item (click)="closeTabsToRight(tab, index)">Close to the Right</button>
      <button mat-menu-item (click)="closeAllTabs()">Close All</button>
      <mat-divider></mat-divider>
      <button mat-menu-item (click)="togglePinTab(tab)">{{ tab?.pinned ? 'Unpin' : 'Pin' }}</button>
    </span>
  </ng-template>
</mat-menu>
