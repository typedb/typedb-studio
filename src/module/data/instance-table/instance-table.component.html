<div class="instance-table-container">
  <!-- Stale data banner -->
  @if (isDataStale) {
    <div class="stale-data-banner">
      <i class="fa-light fa-clock-rotate-left"></i>
      <span>Data was loaded in a different transaction</span>
      <button mat-stroked-button (click)="refresh()">
        <i class="fa-light fa-refresh"></i>
        Refresh
      </button>
    </div>
  }

  <!-- Breadcrumbs -->
  @if (breadcrumbs.length > 0) {
    <div class="breadcrumbs">
      @for (crumb of breadcrumbs; track $index; let i = $index) {
        <button class="breadcrumb-item" (click)="navigateToBreadcrumb(crumb, i)">
          @if (crumb.kind === 'type-table') {
            <i class="fa-light fa-table"></i>
            {{ crumb.typeLabel }}
          } @else {
            {{ crumb.typeLabel }}: {{ crumb.instanceIID!.substring(0, 8) }}...
          }
        </button>
        <i class="fa-light fa-chevron-right breadcrumb-separator"></i>
      }
      <span class="breadcrumb-current">
        <i class="fa-light fa-table"></i>
        {{ tab.type.label }}
      </span>
    </div>
  }

  <!-- Filter/Sort Bar -->
  <div class="filter-sort-bar card-header">
    <div class="search-input-wrapper">
      <i class="fa-light fa-search search-icon"></i>
      <input
        type="text"
        placeholder="Search"
        [(ngModel)]="filterText"
        (input)="onFilterChange(filterText)"
        class="filter-input"
      />
      <button
        mat-icon-button
        class="filter-mode-button"
        (click)="openAdvancedFilterDialog()"
        matTooltip="Advanced TypeQL filter">
        <i class="fa-light fa-code"></i>
      </button>
    </div>

    @if (filterMode === 'advanced' && filterText) {
      <button
        mat-stroked-button
        class="active-filter-chip"
        (click)="openAdvancedFilterDialog()"
        matTooltip="Click to edit filter">
        <i class="fa-light fa-filter"></i>
        TypeQL filter active
      </button>
      <button
        mat-icon-button
        class="clear-filter-button"
        (click)="clearAdvancedFilter()"
        matTooltip="Clear filter">
        <i class="fa-light fa-times"></i>
      </button>
    }

    <div class="flex-spacer"></div>

    <button
      mat-icon-button
      [matMenuTriggerFor]="columnMenu"
      matTooltip="Show/hide columns">
      <i class="fa-light fa-columns-3"></i>
    </button>

    <mat-menu #columnMenu="matMenu" class="column-picker-menu">
      @for (col of allColumns; track col.id) {
        <button mat-menu-item (click)="toggleColumnVisibility(col.id); $event.stopPropagation()">
          <mat-checkbox
            [checked]="isColumnVisible(col.id)"
            (click)="$event.stopPropagation()"
            (change)="toggleColumnVisibility(col.id)">
            {{ col.label }}
          </mat-checkbox>
        </button>
      }
    </mat-menu>

    <button
      mat-icon-button
      (click)="refresh()"
      matTooltip="Refresh"
      [disabled]="loading">
      <i class="fa-light fa-refresh" [class.fa-spin]="loading"></i>
    </button>
  </div>

  <!-- Table -->
  <div class="table-wrapper">
    @if (showSpinner) {
      <div class="loading-overlay">
        <mat-spinner diameter="40"></mat-spinner>
      </div>
    }

    <table
      mat-table
      [dataSource]="dataSource"
      matSort
      (matSortChange)="onSortChange($event)"
      class="instance-table">

      <!-- Type Column -->
      <ng-container matColumnDef="type">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Type</th>
        <td mat-cell *matCellDef="let row" class="type-cell" [class.entity]="row.kind === 'entity'" [class.relation]="row.kind === 'relation'">
          {{ row.type }}
        </td>
      </ng-container>

      <!-- IID Column -->
      <ng-container matColumnDef="iid">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>IID</th>
        <td mat-cell *matCellDef="let row" class="iid-cell" [matTooltip]="row.iid">
          {{ row.iid }}
        </td>
      </ng-container>

      <!-- Dynamic attribute columns -->
      @for (attr of attributeColumns; track attr) {
        <ng-container [matColumnDef]="attr">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>{{ attr }}</th>
          <td mat-cell *matCellDef="let row" class="attribute-cell"
              [matTooltip]="shouldShowTooltip(row[attr]) ? formatAttributeValue(row[attr]) : ''">
            <div class="cell-content-wrapper">
              <span class="cell-content">{{ truncateValue(row[attr]) }}</span>
              @if (formatAttributeValue(row[attr]) !== '-') {
                <button
                  mat-icon-button
                  class="copy-button"
                  (click)="copyToClipboard($event, row[attr])">
                  <i class="fa-light fa-copy"></i>
                </button>
              }
            </div>
          </td>
        </ng-container>
      }

      <!-- Relations column (not sortable) -->
      <ng-container matColumnDef="relationCounts">
        <th mat-header-cell *matHeaderCellDef>Relations</th>
        <td mat-cell *matCellDef="let row"
            [matTooltip]="shouldShowRelationTooltip(row.relationCounts) ? formatRelationCounts(row.relationCounts) : ''">
          {{ truncateRelationCounts(row.relationCounts) }}
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
      <tr
        mat-row
        *matRowDef="let row; columns: displayedColumns"
        (click)="onRowClick(row)"
        class="clickable-row"></tr>
    </table>

    @if (needsTransaction) {
      <div class="transaction-prompt">
        <i class="fa-light fa-lock"></i>
        <p>Open a transaction to explore your data</p>
        <button mat-stroked-button (click)="openTransactionAndLoad()">
          <i class="fa-light fa-play"></i>
          Open read transaction
        </button>
      </div>
    } @else if (!loading && dataSource.length === 0) {
      <div class="empty-state">
        <i class="fa-light fa-inbox"></i>
        <p>No instances found</p>
      </div>
    }
  </div>

  <!-- Pagination -->
  <mat-paginator
    [length]="totalCount"
    [pageSize]="pageSize"
    [pageSizeOptions]="pageSizeOptions"
    [pageIndex]="currentPage"
    (page)="onPageChange($event)"
    showFirstLastButtons>
  </mat-paginator>
</div>
